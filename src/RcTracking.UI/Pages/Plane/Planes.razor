@page "/Plane"

@using RcTracking.Shared.Model
@using RcTracking.UI.Events
@using RcTracking.UI.Services
@using RcTracking.UI.Interface
@inject IDialogService DialogService

<MudGrid Spacing="6" Justify="Justify.SpaceEvenly">
	<MudItem md="6" lg="4">
		<MudCard Outlined="true">
			<MudCardContent>
				<MudText Typo="Typo.h5" GutterBottom="true">Total Planes</MudText>
				@planeCount
			</MudCardContent>
		</MudCard>
	</MudItem>
	<MudItem md="6" lg="8">
		<MudCard Outlined="true">
			<MudCardContent>
				<MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="OpenNewPlaneDialog">Add Plane</MudButton>
			</MudCardContent>
		</MudCard>
	</MudItem>



	@foreach (var plane in planes)
	{
		<MudItem md="6" lg="3">
			<MudCard Outlined="true">
				<MudCardHeader>
					<MudText Typo="Typo.h6">@plane.Name</MudText>
				</MudCardHeader>
				<MudCardContent align-content-start>
					<MudGrid Spacing="6" Justify="Justify.SpaceEvenly">
						<MudItem xs="8">
							<MudText GutterBottom="true">
								Flying:&nbsp;
								@if(@plane.Flying)
								{
									<MudIcon Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle" />
								}
								else
								{
									<MudIcon Color="Color.Error" Icon="@Icons.Material.Filled.Cancel" />
								}
							</MudText>
							<MudText GutterBottom="true">Flights: @PlaneFlights(plane.Id)</MudText>
						</MudItem>
						<MudItem xs="4">
							@if (!string.IsNullOrEmpty(PlaneImage(plane.Id)))
							{
								<MudImage Src="@PlaneImage(plane.Id)" Alt="Plane Image" Fluid="true" />
							}
						</MudItem>
					</MudGrid>
				</MudCardContent>
				<MudCardActions>
					<MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="() => OpenDetailDialog(plane)">Details</MudButton>
				</MudCardActions>
			</MudCard>
		</MudItem>
	}
</MudGrid>

@code {

	[Inject]
	private EventBus EventBus { get; set; }

	[Inject]
	private IPlaneService PlaneService { get; set; }

	[Inject]
	private ICombineDataService CombineDataService { get; set; }

	[Inject]
	private IImageService ImageService { get; set; }

	private int planeCount { get; set; } = 0;
	private List<PlaneModel> planes = new();

	protected override async Task OnInitializedAsync()
	{
		EventBus.OnMessage += OnMessage;

		if (PlaneService.HasLoaded)
		{
			planes = PlaneService.Planes.Values.ToList();
			planeCount = planes.Count;
		}
		else
		{
			await PlaneService.LoadPlanesAsync();
		}
	}

	private void OnMessage(object? sender, EventMessage? e)
	{
		Console.WriteLine($"Event received. Type: {e?.Event.ToString() ?? "none"}");

		if (e?.Event == EventEnum.RefreshPlane ||
			e.Event == EventEnum.PlaneUpdated ||
			e.Event == EventEnum.PlaneAdded)
		{
			planes = PlaneService.Planes.Values.ToList();
			planeCount = planes.Count;
			StateHasChanged();
		}
	}

	private Task OpenNewPlaneDialog()
	{
		var options = new DialogOptions { CloseOnEscapeKey = true };
		var nPlane = new PlaneModel(Guid.Empty, "", "", "", "", false);
		return DialogService.ShowAsync<UpdatePlane>("", new DialogParameters { { "Plane", nPlane }, { "Title", "New Plane" } }, options);
	}

	private int PlaneFlights(Guid id)
	{
		return CombineDataService.PlaneStats.TryGetValue(id, out var stats) ? stats.TotalFlights : 0;
	}

	private string PlaneImage(Guid id)
	{
		if (ImageService.Images.TryGetValue(id, out var imageModel))
		{
			return $"data:image/jpg;base64,{imageModel?.ImageString ?? ""}";
		}
		return "";
	}

	private Task OpenDetailDialog(PlaneModel plane)
	{
		var options = new DialogOptions { CloseOnEscapeKey = true };
		return DialogService.ShowAsync<UpdatePlane>("", new DialogParameters { { "Plane", plane }, { "Title", "New Plane" } }, options);
	}
}
