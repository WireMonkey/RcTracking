@page "/"
@using RcTracking.Shared.Model
@using RcTracking.UI.Events
@using RcTracking.UI.Interface
@using RcTracking.UI.Services
@using Microsoft.Authentication.WebAssembly.Msal;

<MudGrid Spacing="6" Justify="Justify.SpaceEvenly">
	@if (!FlightService.HasLoaded || !PlaneService.HasLoaded)
	{
		<MudItem xs="12">
			<MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
		</MudItem>
	}
	<MudItem xs="6">
		<MudPaper Class="pa-4">
			<MudText Typo="Typo.h5" GutterBottom="true">Total Flights</MudText>
			@flightCount
		</MudPaper>
	</MudItem>
	<MudItem xs="6">
		<MudPaper Class="pa-4">
			<MudText Typo="Typo.h5" GutterBottom="true">This Year</MudText>
			@flightsThisYear
		</MudPaper>
	</MudItem>
	<MudItem xs="6">
		<MudPaper Class="pa-4">
			<MudText Typo="Typo.h5" GutterBottom="true">Total Planes</MudText>
			@planeCount
		</MudPaper>
	</MudItem>
	<MudItem xs="6">
		<MudPaper Class="pa-4">
			<MudText Typo="Typo.h5" GutterBottom="true">Working Planes</MudText>
			@workingPlaneCount
		</MudPaper>
	</MudItem>

	@* Add fun stats like Most flights this year plane with most flights
	Graphs of flights over time
		total and per plane
	Graph of total flights per plane
	Graph of flights per month *@

</MudGrid>

@code {

	[Inject]
	private IFlightService FlightService { get; set; }

	[Inject]
	private IPlaneService PlaneService { get; set; }

	[Inject]
	private ICombineDataService CombineDataService { get; set; }

	[Inject]
	private EventBus EventBus { get; set; }

	[Inject]
	private AuthenticationStateProvider authenticationStateProvider { get; set; }

	[Inject]
	private NavigationManager navigationManager { get; set; }

	private int flightCount { get; set; } = 0;

	private int flightsThisYear { get; set; } = 0;

	private int planeCount { get; set; } = 0;

	private int workingPlaneCount { get; set; } = 0;

	protected override async Task OnInitializedAsync()
	{
		var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
		if (authState.User.Identity is not null && authState.User.Identity.IsAuthenticated)
		{
			EventBus.OnMessage += OnMessage;
			await loadFlights();
			await loadPlanes();
		}
		else
		{
			navigationManager.NavigateTo("authentication/login");
		}

	}

	private void OnMessage(object? sender, EventMessage? e)
	{
		Console.WriteLine($"Event received. Type: {e?.Event.ToString() ?? "none"}");

		switch (e?.Event)
		{
			case EventEnum.FlightAdded:
			case EventEnum.RefreshFlight:
				flightCount = FlightService.TotalFlights();
				flightsThisYear = FlightService.TotalFlights(DateTime.Now.Year);
				InvokeAsync(StateHasChanged);
				break;
			case EventEnum.PlaneAdded:
			case EventEnum.RefreshPlane:
				planeCount = PlaneService.Planes?.Count ?? 0;
				workingPlaneCount = PlaneService.WorkingPlanesCount();
				InvokeAsync(StateHasChanged);
				break;
			default:
				break;
		}
	}

	private async Task loadFlights()
	{
		if (!FlightService.HasLoaded)
		{
			await FlightService.LoadFlightsAsync();
		}
		else
		{
			flightCount = FlightService.TotalFlights();
			flightsThisYear = FlightService.TotalFlights(DateTime.Now.Year);
		}
	}

	private async Task loadPlanes()
	{
		if (!PlaneService.HasLoaded)
		{
			await PlaneService.LoadPlanesAsync();
		}
		else
		{
			planeCount = PlaneService.Planes?.Count ?? 0;
		}
	}
}